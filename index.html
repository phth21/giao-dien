<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart Garden Ultimate (Cloud)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  /* === GI·ªÆ NGUY√äN CSS T·ª™ FILE PYTHON C≈® C·ª¶A B·∫†N === */
  :root { --bg: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%); }
  body { margin:0; font-family: 'Nunito', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; color: #2d3436; padding: 10px; }
  .screen { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 99; display:flex; flex-direction:column; justify-content:center; align-items:center; background: rgba(255,255,255,0.99); transition: 0.3s; }
  .btn { padding: 18px 40px; border:none; border-radius:15px; font-weight:bold; cursor:pointer; color:white; margin: 10px; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  .n { background: #6c5ce7; } .c { background: #0984e3; } .s { background: #d63031; }
  #mainApp { display: none; width: 100%; max-width: 1000px; }
  .card { background: rgba(255,255,255,0.96); border-radius: 30px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; }
  .back-btn { position: absolute; top: 20px; left: 20px; background: #ff7675; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 10; }
  .layout { display: grid; grid-template-columns: 300px 1fr; gap: 40px; margin-top: 40px; }
  .soil-circle { width: 240px; height: 240px; border-radius: 50%; border: 15px solid #dfe6e9; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto; background: white; transition: border-color 0.3s; }
  .soil-num { font-size: 4.5rem; font-weight: 900; color: #00b894; line-height: 1; }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; }
  .stat-box { background: #f1f2f6; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; color: #555; }
  .stat-val { display: block; font-size: 1.3rem; color: #0984e3; }
  .mode-container { display: flex; gap: 20px; }
  .mode-card { background:white; padding:40px; border-radius:20px; cursor:pointer; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.1); width:200px; border:3px solid transparent; }
  .mode-card:hover { border-color: #00b894; transform: translateY(-5px); }
  #panelAuto, #panelManual { display: none; animation: fadeIn 0.5s; }
  .manual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .p-btn { padding: 30px; border:none; border-radius:15px; font-weight:bold; color:white; font-size:1.3rem; cursor:pointer; width: 100%; }
  .bon { background: #00b894; } .boff { background: #636e72; }
  
  /* Th√™m CSS cho Popup L·ªãch S·ª≠ (M·ªõi) */
  #cityPopup, #historyPopup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center; }
  .popup-box { background:white; padding:25px; border-radius:20px; width:350px; text-align:center; max-height:80vh; overflow-y:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
  .city-opt { display:block; width:100%; padding:12px; border:1px solid #eee; background:white; margin-bottom:5px; border-radius:8px; cursor:pointer; font-weight:bold; }
  .city-opt:hover { background:#f0f0f0; color:#0984e3; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .emergency { animation: blink 1s infinite; border-color: red !important; } @keyframes blink { 50% { opacity: 0.5; } }
  
  /* N√∫t xem l·ªãch s·ª≠ ƒë·∫πp h∆°n */
  .hist-btn { display:inline-block; margin-top:10px; background:#6c5ce7; color:white; padding:10px 20px; border-radius:8px; font-weight:bold; border:none; cursor: pointer; text-decoration: none; }
  
  /* B·∫£ng l·ªãch s·ª≠ trong Popup */
  .hist-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-top:10px; text-align: left; }
  .hist-table th, .hist-table td { padding: 8px; border-bottom: 1px solid #eee; }
  .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; }
  .bg-on { background: #00b894; } .bg-off { background: #d63031; } .bg-ai { background: #0984e3; }
  
  @media (max-width: 800px) { .layout { grid-template-columns: 1fr; } .mode-container { flex-direction:column; } }
</style>
</head>
<body>

<div id="screenRegion" class="screen">
  <h1>üå± Smart Garden</h1>
  <p>B∆∞·ªõc 1: Ch·ªçn khu v·ª±c c·ªßa b·∫°n</p>
  <div>
    <button class="btn n" onclick="emit('select_region', {region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
    <button class="btn c" onclick="emit('select_region', {region:'CENTRAL'})">Mi·ªÅn Trung</button>
    <button class="btn s" onclick="emit('select_region', {region:'SOUTH'})">Mi·ªÅn Nam</button>
  </div>
</div>

<div id="screenMode" class="screen" style="display:none">
  <h1>Ch·ªçn Ch·∫ø ƒê·ªô V·∫≠n H√†nh</h1>
  <p>B∆∞·ªõc 2: B·∫°n mu·ªën t∆∞·ªõi th·∫ø n√†o?</p>
  <div class="mode-container">
    <div class="mode-card" onclick="emit('enter_mode', {mode:'AUTO'})">
        <div style="font-size:3rem">ü§ñ</div>
        <h3>AI AUTO</h3>
        <p style="color:#666; font-size:0.9rem">T·ª± ƒë·ªông theo th·ªùi ti·∫øt</p>
    </div>
    <div class="mode-card" onclick="emit('enter_mode', {mode:'MANUAL'})">
        <div style="font-size:3rem">üéÆ</div>
        <h3>TH·ª¶ C√îNG</h3>
        <p style="color:#666; font-size:0.9rem">B·∫°n t·ª± ƒëi·ªÅu khi·ªÉn</p>
    </div>
  </div>
</div>

<div id="mainApp">
  <div class="card">
    <button class="back-btn" onclick="exit()">‚¨Ö Tho√°t ra Menu</button>
    
    <div class="layout">
      <div style="text-align:center">
        <div class="soil-circle" id="soilBox">
          <span class="soil-num" id="soil">--</span><span>ƒê·ªò ·∫®M %</span>
        </div>
        <div style="margin-top:20px; font-weight:bold; font-size:1.4rem" id="pumpSt">B∆†M T·∫ÆT</div>
        <div id="warn" style="color:red; font-weight:bold; margin-top:10px; min-height:20px"></div>
        
        <button onclick="openHistory()" class="hist-btn">üìú Xem Nh·∫≠t K√Ω</button>
      </div>

      <div>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px">
             <h2 style="margin:0" id="loc">...</h2>
             <button onclick="openCityPopup()" style="background:#eee; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold; color:#555">‚úé ƒê·ªïi ƒë·ªãa ƒëi·ªÉm</button>
        </div>

        <div class="stats-grid">
           <div class="stat-box"><span class="stat-val" id="temp">--</span>Nhi·ªát ƒë·ªô</div>
           <div class="stat-box"><span class="stat-val" id="hum">--</span>ƒê·ªô ·∫©m</div>
           <div class="stat-box"><span class="stat-val" id="rain">--</span>M∆∞a</div>
        </div>

        <div id="panelAuto">
           <div style="background:#e3f2fd; padding:25px; border-radius:20px; border-left:6px solid #0984e3">
               <h3>ü§ñ AI ƒêang L√†m Vi·ªác</h3>
               <p>üïí <b>Khi n√†o t∆∞·ªõi:</b> <span id="aiTime" style="color:#d63031; font-weight:bold">...</span></p>
               <p>üéØ <b>Ng∆∞·ª°ng d·ª´ng:</b> <span id="aiTarget" style="font-weight:bold; color:#2d3436">...</span> (T·ª± ng·∫Øt khi ƒë·∫°t)</p>
               <hr>
               <p>üí° <i><span id="aiReason">...</span></i></p>
           </div>
        </div>

        <div id="panelManual">
           <div class="manual-grid">
              <button class="p-btn bon" onclick="pump(true)">B·∫¨T B∆†M</button>
              <button class="p-btn boff" onclick="pump(false)">T·∫ÆT B∆†M</button>
           </div>
           <p style="text-align:center; color:#888; margin-top:20px">‚ö†Ô∏è B·∫°n ƒëang ƒëi·ªÅu khi·ªÉn tr·ª±c ti·∫øp.</p>
        </div>

      </div>
    </div>
  </div>
</div>

<div id="cityPopup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box">
        <h3>Ch·ªçn T·ªânh Th√†nh</h3>
        <div id="cityList"></div>
        <button onclick="document.getElementById('cityPopup').style.display='none'" style="margin-top:15px; background:#ff7675; border:none; padding:10px 20px; color:white; border-radius:10px; cursor:pointer; font-weight:bold">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box" style="width: 500px; max-width: 90%;">
        <h3>üìú Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</h3>
        <input type="date" id="dateInput" style="padding:5px; margin-bottom:10px" onchange="loadHistory()">
        <div style="max-height:300px; overflow-y:auto">
            <table class="hist-table">
                <thead><tr><th>Gi·ªù</th><th>H√†nh ƒë·ªông</th><th>Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
        <button onclick="document.getElementById('historyPopup').style.display='none'" style="margin-top:15px; background:#ff7675; border:none; padding:10px 20px; color:white; border-radius:10px; cursor:pointer; font-weight:bold">ƒê√≥ng</button>
    </div>
</div>

<script>
  // --- 1. FIREBASE CONFIG ---
  // Thay th·∫ø b·∫±ng Config c·ªßa b·∫°n n·∫øu c·∫ßn
  const firebaseConfig = {
    apiKey: "AIzaSyD5d7s-pjoQO4N_a_0OsPAhTMxSkNZOkCY",
    authDomain: "tuoicay-30be7.firebaseapp.com",
    databaseURL: "https://tuoicay-30be7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tuoicay-30be7",
    storageBucket: "tuoicay-30be7.firebasestorage.app",
    messagingSenderId: "337051698716",
    appId: "1:337051698716:web:175874891d781c644c81d9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- 2. MQTT CONFIG ---
  const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
  const PREFIX = "thaocute_smartgarden/";
  const client = mqtt.connect(BROKER_URL);

  client.on('connect', function () {
    console.log('Connected to MQTT');
    client.subscribe(PREFIX + 'update');
  });

  client.on('message', function (topic, message) {
    if (topic === PREFIX + 'update') {
      let d = JSON.parse(message.toString());
      currentRegion = d.region; 
      
      // Chuy·ªÉn m√†n h√¨nh
      document.getElementById('screenRegion').style.display = (d.step === 0) ? 'flex' : 'none';
      document.getElementById('screenMode').style.display   = (d.step === 1) ? 'flex' : 'none';
      document.getElementById('mainApp').style.display      = (d.step === 2) ? 'block' : 'none';

      // C·∫≠p nh·∫≠t d·ªØ li·ªáu
      document.getElementById('loc').innerText = d.location;
      document.getElementById('temp').innerText = d.temp + "¬∞";
      document.getElementById('hum').innerText = d.humidity + "%";
      document.getElementById('rain').innerText = d.rain;
      document.getElementById('soil').innerText = d.soil;
      document.getElementById('warn').innerText = d.warning;

      if (d.step === 2) {
          document.getElementById('panelAuto').style.display = (d.mode === 'AUTO') ? 'block' : 'none';
          document.getElementById('panelManual').style.display = (d.mode === 'MANUAL') ? 'block' : 'none';
          if(d.mode === 'AUTO') {
             document.getElementById('aiTime').innerText = d.ai_timing;
             document.getElementById('aiTarget').innerText = d.ai_target;
             document.getElementById('aiReason').innerText = d.ai_reason;
          }
      }

      const box = document.getElementById('soilBox');
      if(d.soil < 26) { box.classList.add('emergency'); box.style.borderColor='red'; }
      else { box.classList.remove('emergency'); box.style.borderColor='#dfe6e9'; }

      const pst = document.getElementById('pumpSt');
      if(d.pump) { pst.innerText = "ƒêANG B∆†M..."; pst.style.color="#00b894"; }
      else { pst.innerText = "M√ÅY B∆†M T·∫ÆT"; pst.style.color="#636e72"; }
    }
  });

  const REGIONAL_CITIES = {
    'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "B·∫Øc Ninh", "H∆∞ng Y√™n", "Nam ƒê·ªãnh", "Th√°i B√¨nh", "Ninh B√¨nh", "L√†o Cai"],
    'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang", "Vinh", "Quy Nh∆°n", "Thanh H√≥a", "ƒê√† L·∫°t"],
    'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "V≈©ng T√†u", "B√¨nh D∆∞∆°ng", "ƒê·ªìng Nai", "Long An", "C√† Mau"]
  };
  let currentRegion = 'NORTH';

  function exit() {
     if(confirm("Tho√°t ch·∫ø ƒë·ªô n√†y? B∆°m s·∫Ω T·∫ÆT.")) {
        emit('exit_dashboard', {});
     }
  }

  function openCityPopup() {
     const list = document.getElementById('cityList');
     list.innerHTML = "";
     const cities = REGIONAL_CITIES[currentRegion] || [];
     cities.forEach(c => {
         let btn = document.createElement('button');
         btn.className = 'city-opt';
         btn.innerText = c;
         btn.onclick = () => {
             emit('set_city', {city: c});
             document.getElementById('cityPopup').style.display = 'none';
         };
         list.appendChild(btn);
     });
     document.getElementById('cityPopup').style.display = 'flex';
  }

  function openHistory() {
      document.getElementById('historyPopup').style.display = 'flex';
      document.getElementById('dateInput').valueAsDate = new Date();
      loadHistory();
  }

  function loadHistory() {
      const date = document.getElementById('dateInput').value;
      const tbody = document.getElementById('histBody');
      tbody.innerHTML = '<tr><td colspan="3">ƒêang t·∫£i...</td></tr>';
      
      db.ref('history/' + date).once('value').then(snapshot => {
          const data = snapshot.val();
          tbody.innerHTML = '';
          if(!data) { tbody.innerHTML = '<tr><td colspan="3">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; }
          
          const items = Object.values(data).sort((a,b) => (a.time < b.time) ? 1 : -1);
          items.forEach(item => {
              let cls = 'bg-ai';
              if(item.action.includes('ON')) cls='bg-on';
              if(item.action.includes('OFF')) cls='bg-off';
              tbody.innerHTML += `<tr>
                <td><b>${item.time}</b></td>
                <td><span class="tag ${cls}">${item.action}</span></td>
                <td>${item.detail} (${item.soil}%)</td>
              </tr>`;
          });
      });
  }

  function pump(st) { emit('user_control', {pump: st}); }
  function emit(ev, d) { client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: d})); }
</script>
</body>
</html>
